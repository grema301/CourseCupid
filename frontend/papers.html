<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Papers • Course Cupid</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { cupidPink: '#C05A66', cupidCream: '#FAF5EF' } } } };
  </script>
</head>
<body class="bg-cupidCream min-h-screen text-slate-900">
  <header class="flex items-center justify-between px-8 py-6">
    <a href="index.html" class="flex items-center gap-3">
      <img src="images/cupid_logo.png" alt="Course Cupid" class="h-8">
      <span class="text-lg font-semibold text-cupidPink">Course Cupid</span>
    </a>
<nav class="hidden md:flex gap-6 lg:gap-10 text-sm">
  <a href="index.html" class="hover:text-cupidPink transition-all duration-300 hover:scale-105 relative group">
    Home
    <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-cupidPink transition-all duration-300 group-hover:w-full"></span>
  </a>
  <a href="aboutus.html" class="hover:text-cupidPink transition-all duration-300 hover:scale-105 relative group">
    About Us
    <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-cupidPink transition-all duration-300 group-hover:w-full"></span>
  </a>
  <a href="quiz.html" class="hover:text-cupidPink transition-all duration-300 hover:scale-105 relative group">
    Quiz
    <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-cupidPink transition-all duration-300 group-hover:w-full"></span>
  </a>
  <a href="papers.html" class="text-cupidPink font-semibold relative group">
    Papers
    <span class="absolute bottom-0 left-0 w-full h-0.5 bg-cupidPink"></span>
  </a>
  <a href="/chat/default" class="hover:text-cupidPink transition-all duration-300 hover:scale-105 relative group">
        Chatbot
        <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-cupidPink transition-all duration-300 group-hover:w-full"></span>
      </a>
  <a href="contact.html" class="hover:text-cupidPink transition-all duration-300 hover:scale-105 relative group">
    Contact
    <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-cupidPink transition-all duration-300 group-hover:w-full"></span>
  </a>
</nav>
    <div id="auth-controls" class="flex items-center gap-4">
      <div id="auth-guest" class="flex gap-3 items-center">
        <a id="login-link" href="login.html" class="px-4 py-2 rounded-full bg-cupidPink/10 text-cupidPink hover:bg-cupidPink/20 font-medium">Log In</a>
        <a id="signup-link" href="signup.html" class="px-4 py-2 rounded-full bg-cupidPink text-white font-semibold">Register</a>
      </div>
      <div id="auth-user" class="hidden relative flex items-center gap-2">
        <div id="profile-btn" class="flex items-center gap-2 bg-white border border-cupidPink/20 rounded-full px-2 py-1 shadow-sm cursor-pointer">
          <div id="user-avatar" class="w-8 h-8 rounded-full bg-cupidPink text-white flex items-center justify-center font-semibold text-sm"></div>
          <span id="user-name" class="text-cupidPink font-medium text-sm max-w-[120px] truncate"></span>
        </div>
        <div id="profile-menu"
             class="absolute right-0 top-full mt-2 w-44 bg-white rounded-lg shadow-lg border border-cupidPink/10 z-50 overflow-hidden
                    transform transition-all duration-150 origin-top-right opacity-0 -translate-y-2 scale-95 pointer-events-none">
          <div class="py-1">
            <a href="settings.html" class="block px-4 py-2 text-sm text-cupidPink hover:bg-cupidPink/5">Settings</a>
            <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="px-8 pb-16">
    <div class="max-w-6xl mx-auto">

      <div class="sticky top-0 z-30 bg-cupidCream/95 backdrop-blur-sm border-b border-cupidPink/5 py-4">
        <div class="max-w-6xl mx-auto px-0">
          <div class="flex items-center justify-between mb-3">
            <h1 class="text-3xl text-cupidPink mb-0">All papers</h1>
            <div class="text-sm text-gray-600" id="total-count">Loading…</div>
          </div>

          <div class="flex flex-wrap items-center gap-4">
            <input id="search" type="search" placeholder="Search by code..." class="flex-1 min-w-[220px] border rounded-lg px-4 py-2 bg-white" />
            <button id="reset" class="px-3 py-2 rounded-lg bg-white border text-sm">Reset</button>
          </div>
        </div>
      </div>

      <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

      <div id="loading" class="mt-6 text-center text-gray-500 hidden">Loading...</div>
      <div id="empty" class="mt-6 text-center text-gray-500 hidden">No papers match your search.</div>
      <div id="scroll-sentinel" class="h-8"></div>
    </div>
  </main>

  <script>
    const pageSize = 20;
    let page = 1;
    let total = 0;
    let loading = false;
    let lastSearch = '';

    const grid = document.getElementById('grid');
    const loadingEl = document.getElementById('loading');
    const emptyEl = document.getElementById('empty');
    const totalCountEl = document.getElementById('total-count');
    const sentinel = document.getElementById('scroll-sentinel');
    
    let allPapers = []; // full list from imported_papers.json

    function makeCard(p) {
      const a = document.createElement('a');
      a.className = 'block text-left bg-white rounded-xl p-4 shadow-sm border border-cupidPink/5 hover:shadow-md transition';
      const code = p.code || p.paper_code || p.paper || p.PAPERCODE || '';
      const title = p.title || p.name || p.paper_title || p.course || p.course_title || 'Untitled';
      const desc = p.description || p.summary || p.desc || p.abstract || '';
      a.href = `/chat/${encodeURIComponent(code)}`;
      a.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="w-12 h-12 flex items-center justify-center rounded-full bg-cupidPink text-white font-semibold text-sm">${(title && title[0]) || (code && code[0]) || ''}</div>
          <div class="flex-1">
            <div class="text-sm text-cupidPink font-semibold">${code}</div>
            <div class="text-md font-medium mt-1">${title}</div>
            <p class="mt-2 text-xs text-gray-600 line-clamp-3">${desc}</p>
          </div>
        </div>
      `;
      return a;
    }

    function renderNextPage(filtered) {
      const start = (page - 1) * pageSize;
      const chunk = filtered.slice(start, start + pageSize);
      chunk.forEach(it => grid.appendChild(makeCard(it)));
      page++;
      if (grid.children.length >= filtered.length) {
        sentinel.style.display = 'none';
      } else {
        sentinel.style.display = '';
      }
      totalCountEl.textContent = `Showing ${grid.children.length} of ${filtered.length} papers`;
      if (filtered.length === 0) emptyEl.classList.remove('hidden'); else emptyEl.classList.add('hidden');
    }

    async function loadPapers() {
      loading = true;
      loadingEl.classList.remove('hidden');
      try {
        const resp = await fetch('/imported_papers.json', { cache: 'no-store' });
        if (!resp.ok) throw new Error('Failed to load imported_papers.json: ' + resp.status);
        const json = await resp.json();
        if (Array.isArray(json)) allPapers = json;
        else if (json && typeof json === 'object') allPapers = Object.values(json);
        else allPapers = [];
        allPapers = allPapers.map(raw => {
          return {
            code: raw.code || raw.paper_code || raw.paper || raw.PAPERCODE || raw.papercode || '',
            title: raw.title || raw.name || raw.paper_title || raw.course || raw.course_title || '',
            description: raw.description || raw.summary || raw.desc || raw.abstract || '',
            year: raw.year || raw.level || raw.year_level || ''
          };
        });
        total = allPapers.length;
        page = 1;
        grid.innerHTML = '';
        const filtered = applyFilters();
        renderNextPage(filtered);
      } catch (err) {
        console.error('Failed to load papers:', err);
        allPapers = [];
        total = 0;
        grid.innerHTML = '';
        totalCountEl.textContent = 'Showing 0 of 0 papers';
        emptyEl.classList.remove('hidden');
        sentinel.style.display = 'none';
      } finally {
        loading = false;
        loadingEl.classList.add('hidden');
      }
    }

    function applyFilters() {
      let filtered = allPapers.slice();
      if (lastSearch) {
        const q = lastSearch.toLowerCase();
        filtered = filtered.filter(p => (String(p.code || p.paper_code || p.paper || '').toLowerCase()).includes(q));
      }
      return filtered;
    }

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !loading) {
          const filtered = applyFilters();
          if (grid.children.length < filtered.length) {
            renderNextPage(filtered);
          }
        }
      });
    }, { root: null, rootMargin: '0px', threshold: 0.2 });
    observer.observe(sentinel);

    document.getElementById('search').addEventListener('input', (e) => {
      lastSearch = e.target.value.trim();
      clearTimeout(window._papersDebounce);
      window._papersDebounce = setTimeout(() => {
        page = 1;
        grid.innerHTML = '';
        const filtered = applyFilters();
        renderNextPage(filtered);
      }, 200);
    });

    document.getElementById('reset').addEventListener('click', () => {
      document.getElementById('search').value = '';
      lastSearch = '';
      page = 1;
      grid.innerHTML = '';
      const filtered = applyFilters();
      renderNextPage(filtered);
    });

    loadPapers();
  </script>
  <script src="/frontend/app.js"></script>
  <script>
    async function refreshAuthUI_Safe() {
      if (typeof refreshAuthUI === 'function') return refreshAuthUI();
      try {
        const res = await fetch('/api/me', { credentials: 'same-origin' });
        const d = await res.json();
        const guest = document.getElementById('auth-guest');
        const userBox = document.getElementById('auth-user');
        if (d.loggedIn) {
          guest.classList.add('hidden');
          userBox.classList.remove('hidden');
          const name = d.user?.username || 'User';
          const userNameEl = document.getElementById('user-name');
          userNameEl.textContent = name;
          const avatar = document.getElementById('user-avatar');
          const parts = name.trim().split(/\s+/).filter(Boolean);
          const initials = parts.length === 1 ? (/[A-ZaZ]/.test(parts[0][0]) ? parts[0][0].toUpperCase() : '#') : (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
          avatar.textContent = initials;
        } else {
          guest.classList.remove('hidden');
          userBox.classList.add('hidden');
        }
      } catch (e) { console.error(e); }
    }

    function initProfileMenu_Fallback() {
      if (typeof initProfileMenu === 'function') return initProfileMenu();
      const btn = document.getElementById('profile-btn');
      const menu = document.getElementById('profile-menu');
      if (!btn || !menu) return;
      const openCls = ['opacity-100','translate-y-2','scale-100','pointer-events-auto'];
      const closedCls = ['opacity-0','-translate-y-2','scale-95','pointer-events-none'];
      menu.classList.remove(...openCls); menu.classList.add(...closedCls);
      btn.setAttribute('aria-haspopup','true'); btn.setAttribute('aria-expanded','false');
      const open = () => { menu.classList.remove(...closedCls); menu.classList.add(...openCls); btn.setAttribute('aria-expanded','true'); };
      const close = () => { menu.classList.remove(...openCls); menu.classList.add(...closedCls); btn.setAttribute('aria-expanded','false'); };
      btn.addEventListener('click', e => { e.stopPropagation(); (menu.classList.contains('pointer-events-auto') ? close() : open()); });
      document.addEventListener('click', () => close());
      document.addEventListener('keydown', e => { if (e.key === 'Escape') close(); });
    }

    document.addEventListener('DOMContentLoaded', () => {
      refreshAuthUI_Safe().then(initProfileMenu_Fallback);
      document.getElementById('logout-btn')?.addEventListener('click', async () => {
        try {
          const r = await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
          const j = await r.json();
          if (j.success) { await refreshAuthUI_Safe(); window.location = '/'; }
        } catch (err) { console.error(err); }
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const current = (location.pathname.split('/').pop() || 'index.html').toLowerCase();
      document.querySelectorAll('header nav a[href]').forEach(a => {
        const hrefName = (a.getAttribute('href').split('/').pop() || '').toLowerCase();
        if (hrefName === current || (current === 'index.html' && (hrefName === '' || hrefName === 'index.html'))) {
          a.classList.add('font-medium');
        } else {
          a.classList.remove('font-medium');
        }
      });
    });
  </script>
</body>
</html>